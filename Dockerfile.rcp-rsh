FROM ghcr.io/prl-prg/rcp-base

ARG RSH_COMMIT

# Until we figure our how to pass SSH AUTH
# RUN mkdir -p -m 0700 /root/.ssh \
#    && ssh-keyscan github.com >> /root/.ssh/known_hosts
RUN git config --global url."https://github.com/".insteadOf git@github.com:

RUN --mount=type=ssh git clone git@github.com:PRL-PRG/r-compile-server.git /rsh && \
    git -C /rsh checkout --detach ${RSH_COMMIT} && \
    git -C /rsh submodule update --init --depth 1 external/R

RUN cd /rsh && \
    bash -x ./tools/build-gnur.sh external/R

ENV RSH_R_HOME=/rsh/external/R

RUN "$RSH_R_HOME/bin/R" -e 'install.packages("microbenchmark", repos="https://cloud.r-project.org")'
